window.backboneDemoDs2014={Models:{},Collections:{},Views:{MapView:Backbone.View.extend({initialize:function(){_.bindAll(this);var a=new esri.geometry.Extent({xmin:-2332499,ymin:-1530060,xmax:2252197,ymax:1856904,spatialReference:{wkid:102003}});this.map=new esri.Map("map",{extent:a,lods:[{level:0,resolution:3966,scale:15e6}],slider:!1}),this.fl=new esri.layers.FeatureLayer("http://sampleserver6.arcgisonline.com/arcgis/rest/services/Census/MapServer/3",{maxAllowableOffset:this.map.extent.getWidth()/this.map.width,mode:esri.layers.FeatureLayer.MODE_SNAPSHOT,outFields:["STATE_NAME"],visible:!0}),this.fl.setRenderer(new esri.renderer.SimpleRenderer(null)),this.updateEndHandler=this.fl.on("update-end",this.onUpdateEnd),this.map.addLayer(this.fl)},el:"#map",onUpdateEnd:function(){this.updateEndHandler.remove();var a=esri.request({url:"http://apify.heroku.com/api/gasprices.json",callbackParamName:"callback"});a.then(this.drawFeatureLayer,this.pricesError)},statePrices:{},drawFeatureLayer:function(a){var b=JSON.parse(a);console.log("join prices, number of graphics: ",this.fl.graphics.length);var c,d=1/0,e=-1/0;_.each(b,function(a){"State"!==a.state&&(c=parseFloat(parseFloat(a.regular.replace("$","")).toFixed(2)),this.statePrices[a.state]=c,d>c&&(d=c),c>e&&(e=c))},this),e=this.formatDollars(e);var f;_.each(this.fl.graphics,function(a){f=this.statePrices[a.attributes.STATE_NAME].toFixed(2),a.attributes.GAS_DISPLAY=f},this);var g=this.calcBreaks(d,e,4),h=esri.symbol.SimpleFillSymbol,i=esri.symbol.SimpleLineSymbol,j=i("solid",new dojo.Color("#444"),1),k=new esri.renderer.ClassBreaksRenderer(null,this.findGasPrice);k.setMaxInclusive(!0),k.addBreak(g[0],g[1],new h("solid",j,new dojo.Color([255,255,178,.75]))),k.addBreak(g[1],g[2],new h("solid",j,new dojo.Color([254,204,92,.75]))),k.addBreak(g[2],g[3],new h("solid",j,new dojo.Color([253,141,60,.75]))),k.addBreak(g[3],e,new h("solid",j,new dojo.Color([227,26,28,.75]))),this.fl.setRenderer(k),this.fl.redraw();var l=new esri.dijit.Legend({map:this.map,layerInfos:[{layer:this.fl,title:"Regular Gas"}]},"legend");l.startup(),$("#loading").remove()},findGasPrice:function(a){var b=a.attributes.STATE_NAME;return this.statePrices[b]},calcBreaks:function(a,b,c){for(var d=(b-a)/c,e=[],f=0;c>f;f++)e[f]=this.formatDollars(a+d*f);return e},formatDollars:function(a){return dojo.number.format(a,{places:2})},pricesError:function(a){console.log("error getting gas price data: ",a)}})},Routers:{},init:function(){"use strict";require(["dojo/json","dojo/_base/connect","dojo/_base/Color","dojo/number","esri/map","esri/geometry/Extent","esri/symbols/SimpleLineSymbol","esri/symbols/SimpleFillSymbol","esri/renderers/SimpleRenderer","esri/renderers/ClassBreaksRenderer","esri/layers/FeatureLayer","esri/dijit/Legend","esri/request","dojo/domReady!"],function(){new backboneDemoDs2014.Views.MapView})}},$(function(){"use strict";backboneDemoDs2014.init()}),this.JST=this.JST||{};